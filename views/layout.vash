<html>
   <head>
      <title> PSO | Library Management System </title>
      <link rel="shortcut icon" href="/static/images/favicon.svg">
      <!--- BOOTSTRAP // JQUERY -->
      <link href="/css/bootstrap.min.css" rel="stylesheet" />
      <script type="text/javascript" src="/js/bootstrap.min.js"></script>
      <script type="text/javascript" src="/static/js/jquery-3.6.0.min.js"></script>
      <!---- PUBLIC -->
      <link href="/static/css/layout.css" rel="stylesheet" />
      <link href="/static/css/login.css" rel="stylesheet" />
      <link href="/static/css/editbooks.css" rel="stylesheet" />
      <!--- DATATABLES -->
      <link rel="stylesheet" href="/static/css/jquery.dataTables.min.css">
      <link rel="stylesheet" href="/static/css/bootstrap.min.css">
      <link rel="stylesheet" href="/static/css/dataTables.bootstrap5.min.css">
      <script type="text/javascript" src="/static/js/jquery.dataTables.min.js"></script>
      <script type="text/javascript" src="/static/js/dataTables.buttons.min.js"></script>
      <script type="text/javascript" src="/static/js/jquery-3.5.1.js"></script>
      <script type="text/javascript" src="/static/js/jquery.dataTables.min.js"></script>
      <script type="text/javascript" src="/static/js/dataTables.buttons.min.js"></script>
      <script type="text/javascript" src="/static/js/jszip.min.js"></script>
      <script type="text/javascript" src="/static/js/pdfmake.min.js"></script>
      <script type="text/javascript" src="/static/js/vfs_fonts.js"></script>
      <script type="text/javascript" src="/static/js/buttons.html5.min.js"></script>
      <script type="text/javascript" src="/static/js/buttons.print.min.js"></script>
   </head>
   <body class="container">
      <!-- Displaying Navbar According to Authenticated User -->
      <nav class="navbar navbar-expand-sm navbar-light mt-4">
         <div class="container-fluid">
            <!-- Displaying Authenticated User Full Name -->
            @{ if(model.email !== undefined) {
            <a class="navbar-brand" href="/">
            <img src="/static/images/favicon.svg" width="30" height="30" class="d-inline-block align-top" alt="">
            Library Managment System 
            </a> //<!--  <span style="color:green">( Logged In : @model.fullName )</span> -->
            } else {
            <a class="navbar-brand" href="/">
            <img src="/static/images/favicon.svg" width="30" height="30" class="d-inline-block align-top" alt="">
            Library Managment System
            </a>
            }}
            <div class="collapse navbar-collapse" id="navbarNav">
               <ul class="navbar-nav ms-auto">
                  <!-- Displaying Navlinks depending on Authentication -->
                  @{ if(model.email !== undefined) {
                  <li class="nav-item">
                     <a class="nav-link" href="/">View Books</a>
                  </li>
                  <li class="nav-item">
                     <a class="nav-link" href="/">View Issued Books</a>
                  </li>
                   <li class="nav-item">
                     <a class="nav-link" href="/">View Defaulters</a>
                  </li>
                  <li id="registerAdmin" class="nav-item">
                     <a class="nav-link">Register Admin</a>
                  </li>
                  <li onclick="onChangePasswordClick('@model.email')" class="nav-item">
                     <a class="nav-link">
                        Change Password</>
                  </li>
                  <li class="nav-item">
                  <a class="nav-link" href="/logout">Logout</a>
                  </li>
                  } else {
                  <li class="nav-item">
                     <a class="nav-link" href="/">View Books</a>
                  </li>
                  <li  class="nav-item">
                     <a class="nav-link" href="/login">Login</a>
                  </li>
                  }}
               </ul>
            </div>
         </div>
      </nav>
      <div class="container">
         @html.block('body')
      </div>
      <footer>
         <!-- Copyright -->
         <div class="footer-copyright text-center py-3">
            <hr>
            Â© 2022 Copyright
            <a style="color: black;text-decoration:none" href="https://psopk.com/"><strong>Pakistan State Oil</strong></a>
         </div>
         <!-- Copyright -->
      </footer>
      <!--------------------- REGISTER ADMIN MODAL ---------------------------------->
      <div class="modal fade" id="registerAdminModal">
         <div class="modal-dialog">
            <div class="modal-content">
               <div class="modal-header">
                  <h5 class="modal-title">Registering new Administrator</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
               </div>
               <div class="modal-body">
                  <div id="loadingScreen" class="overlay"> </div> <!-- LOADING OVERLAY -->
                  <form id="registerAdminForm" action="POST" method="submit">
                     <div class="mb-3">
                        <label class="col-form-label">First Name</label>
                        <input required id="registerFirstNameInput" type="text" class="form-control" id="recipient-name">
                     </div>
                     <div class="mb-3">
                        <label class="col-form-label">Last Name</label>
                        <input required id="registerLastNameInput" type="text" class="form-control" id="recipient-name">
                     </div>
                     <div class="mb-3">
                        <label class="col-form-label">Email Address</label>
                        <input required id="registerEmailInput" type="email" class="form-control" id="recipient-name">
                     </div>
                     <div class="mb-3">
                        <label class="col-form-label">Password</label>
                        <input required id="registerPasswordInput" type="password" class="form-control" id="recipient-name">
                     </div>
                     <br>
                     <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button id="registerAdminConfirm" type="submit" class="btn btn-success">Register Admin</button>
                     </div>
                  </form>
               </div>
            </div>
         </div>
      </div>
      <script>
         $("#registerAdmin").click(function() {
             $("#registerAdminModal").modal('show');
         })
         
         $("#registerAdminForm").submit(function(e) {
             e.preventDefault();
             $("body").addClass("loading");
             $("#registerAdminConfirm").addClass("disabled");
             
             let firstName = $("#registerFirstNameInput").val();
             let lastName  = $("#registerLastNameInput").val();
             let email = $("#registerEmailInput").val();
             let password = $("#registerPasswordInput").val();

             let dataObj = {
                     firstName,
                     lastName,
                     email,
                     password
                 }
         
                 let data = JSON.stringify(dataObj);
                 const url = "http://localhost:4000/register";
                 let xhr = new XMLHttpRequest();
         
                 xhr.open("POST", url, true);
                 xhr.setRequestHeader("Content-type", "application/json; charset=UTF-8");
                 xhr.send(data);
         
                 xhr.onload = function () {
                     if(xhr.status === 200) {
                         $("body").removeClass("loading");
                         $("#registerAdminModal").modal('hide');
                         $("#registerAdminConfirm").removeClass("disabled");
                         alert("New Administrator Registered")
                     } if(xhr.status === 400) {
                         alert(xhr.responseText)
                         $("body").removeClass("loading");
                         $("#registerAdminConfirm").removeClass("disabled");
                     }
                 }

         })
         
         //Changing Password
         function onChangePasswordClick(email) {
             newPassword = window.prompt("Enter new password")
             if(newPassword === null || newPassword === " " || newPassword === "") {
                 //
             } else {
                 
                 let dataObj = {
                     email: email,
                     newPassword: newPassword
                 }
         
                 let data = JSON.stringify(dataObj);
                 const url = "http://localhost:4000/login/password";
                 let xhr = new XMLHttpRequest();
         
                 xhr.open("PUT", url, true);
                 xhr.setRequestHeader("Content-type", "application/json; charset=UTF-8");
                 xhr.send(data);
         
                 xhr.onload = function () {
                     if(xhr.status === 200) {
                         alert(xhr.responseText)
                     } if(xhr.status === 400) {
                         alert(xhr.responseText)
                     }
                 }
         
                 //alert("Password changed for " + email)
             }
         }
         
      </script>
   </body>
</html>